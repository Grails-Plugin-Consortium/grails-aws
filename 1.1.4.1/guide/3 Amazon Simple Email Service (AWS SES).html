<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>3 Amazon Simple Email Service (AWS SES)</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    <h1><a name="3 Amazon Simple Email Service (AWS SES)">3 Amazon Simple Email Service (AWS SES)</a></h1>Amazon Simple E-mail Service (SES for now), it is a Sending E-mail Service provided by amazon, with a real low cost for users. The plugin interacts with it, so you can send e-mails using SES infrastructure without extra code in your app.<p class="paragraph"/>If you just want to send e-mails using your non-SES infrastructure, this plugin won't help you, I recommend you to use the great <strong class="bold">Grails Mail Plugin</strong> (http://grails.org/plugin/mail).<p class="paragraph"/>Unfortunately, SES does not provide a simple SMTP server address to connect and use, otherwise we could just configure the Grails Mail Plugin to use it. Instead of this, AWS provides a http web service for it.<p class="paragraph"/>But, if you really want to use Mail Plugin, you can configure AWS SES with a SMTP Bridge to connect to your SMTP server, but only if you're running Postfix or Sendmail locally. For doing this, check AWS SES Developer Guide.<p class="paragraph"/><blockquote class="warning">
You have to be subscribed to SES, if you are not yet, do it before using the plugin.
</blockquote><p class="paragraph"/>.h3 Interacting with SES<p class="paragraph"/>Grails AWS Plugin adds two types of interacting with AWS Simple Email Service.<h2><a name="3.1 SES Gant scripts">3.1 SES Gant scripts</a></h2>Introductory info on Gant Scripts for AWS Plugin is described in the beginning of this guide (section 1.4).<p class="paragraph"/><h2><a name="3.1.1 Operation VerifyEmail">3.1.1 Operation VerifyEmail</a></h2>To let AWS SES send e-mails using your e-mail as 'from' address, you have to authorize it.<p class="paragraph"/>To to so, you can run the script:<p class="paragraph"/><div class="code"><pre>grails aws&#45;ses&#45;verify&#45;email</pre></div><p class="paragraph"/>You'll be prompted about the e-mail address to verify. After that, SWS will send an confirmation e-mail to this address, you should click on the link in that e-mail to start sending emails using this from.<p class="paragraph"/>You will have to do it for all emails you want to use with SES.<h2><a name="3.1.2 Operation ListVerifiedEmails">3.1.2 Operation ListVerifiedEmails</a></h2>This will allow you to see all verified emails with amazon with the configured credentials.<p class="paragraph"/>To use:<p class="paragraph"/><div class="code"><pre>grails aws&#45;ses&#45;list&#45;verified&#45;emails</pre></div><h2><a name="3.1.3 Operation GetSendQuota">3.1.3 Operation GetSendQuota</a></h2>Retrieves for you the current quota for you. Will give you information on how much emails you can send per day, per second, and the number of e-mails you're allowed to send.<p class="paragraph"/><div class="code"><pre>grails aws&#45;ses&#45;get&#45;send&#45;quota</pre></div><h2><a name="3.1.4 Operation GetSendStatistics">3.1.4 Operation GetSendStatistics</a></h2> <em class="italic">(from aws docs)</em> <p class="paragraph"/>Returns the user's sending statistics (the amount of sent mails, bounced, spammed and etc). The output is a list of items, for the last two weeks of sending activity. Each item in the list contains statistics for a 15-minute interval.<p class="paragraph"/><div class="code"><pre>grails aws&#45;ses&#45;get&#45;send&#45;statistics</pre></div><h2><a name="3.1.5 Testing your verified email">3.1.5 Testing your verified email</a></h2><blockquote class="warning">
Attention: If you only subscribed to Amazon SES and still didn't get access for production using, you'll only be allowed to send e-mails 'from' AND 'to' emais that has been verified with amazon. So, you'll have to use the 'grails aws-ses-verify-email' for both sender and recipient adresses. After getting production access, this won't be needed.                
</blockquote><p class="paragraph"/>This script is a simple utility to test if amazon has verified your email correctly.<p class="paragraph"/>It will queue one test email message for SES. You'll be prompted for the FROM email address and the TO email address to send. Remember, you have to verify these emails first.<p class="paragraph"/><div class="code"><pre>grails aws&#45;ses&#45;send&#45;ping&#45;mail</pre></div><h2><a name="3.2 Sending mail from your application">3.2 Sending mail from your application</a></h2><blockquote class="warning">
Attention: If you only subscribed to Amazon SES and still didn't get access for production using, you'll only be allowed to send e-mails 'from' AND 'to' emais that has been verified with amazon. So, you'll have to use the 'grails aws-ses-verify-email' for both sender and recipient adresses. After getting production access, this won't be needed.                
</blockquote><p class="paragraph"/>Sending e-mails from your application is easy, and you can do it from your services or controllers just calling the <strong class="bold">sesMail</strong> closure that is injected on these artifacts.<p class="paragraph"/><div class="code"><pre>class SesTestController &#123;<p class="paragraph"/>    def sendPlainTextMail = &#123;<p class="paragraph"/>		def mailId = sesMail &#123;
			to <span class="java&#45;quote">"test&#45;email@gmail.com"</span>
			subject <span class="java&#45;quote">"test plain text mail"</span>
			body <span class="java&#45;quote">"sendPlainTextMail ($&#123;<span class="java&#45;keyword">new</span> Date().format('dd/MM/yyyy HH:mm')&#125;)"</span>
		&#125;<p class="paragraph"/>		render <span class="java&#45;quote">"E&#45;mail sent: $&#123;mailId&#125;"</span>
	&#125;
&#125;</pre></div><h2><a name="3.2.1 Configuring the SES options">3.2.1 Configuring the SES options</a></h2>The only option you may want to set on your Config.groovy will be the default <strong class="bold">from</strong> e-mail address that will be used in your e-mails. As said before, this address have to be verified with AWS (check Gant scripts section to see how to do it).<p class="paragraph"/>To configure it, you'll do the following inside the <strong class="bold">grails.plugin.aws</strong> section of your application Config.<p class="paragraph"/><div class="code"><pre>grails &#123;
   plugin &#123;
      aws &#123;<p class="paragraph"/>         ses &#123;
            from = <span class="java&#45;quote">"my&#45;verified&#45;email@gmail.com"</span>
         &#125;<p class="paragraph"/>      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/>Of course, you can override this parameter in every call to the plugin, setting the 'from' parameter.<h2><a name="3.2.2 Sending text emails">3.2.2 Sending text emails</a></h2>To send e-mails, just call the <strong class="bold">sesMail</strong> closure as seen before<p class="paragraph"/><div class="code"><pre>def mailId = sesMail &#123;
	from <span class="java&#45;quote">"origin@gmail.com"</span>
	to <span class="java&#45;quote">"test&#45;email@gmail.com"</span>
	subject <span class="java&#45;quote">"test plain text mail"</span>
	body <span class="java&#45;quote">"<span class="java&#45;keyword">this</span> is the e&#45;mail content, sent at: ($&#123;<span class="java&#45;keyword">new</span> Date().format('dd/MM/yyyy HH:mm')&#125;)"</span>
&#125;</pre></div><p class="paragraph"/>The <strong class="bold">sesMail</strong> returns an unique identifier for this e-mail at Amazon infrastructure, as this one:<p class="paragraph"/><div class="code"><pre>0000012dcde0ea1c&#45;d331d2ec&#45;3972&#45;4a6c&#45;825f&#45;fc980cde3352&#45;000000</pre></div><p class="paragraph"/>Amazon don't provide anything useful to do with this <strong class="bold">id</strong> yet, but I imagine that in a near future, you'll be able to retrieve if this email was delivered correctly, or if it was spammed or bounced. So, feel free to store it if you want to.<p class="paragraph"/><h3>Closure parameters</h3><p class="paragraph"/><h4>AWS Credentials</h4><p class="paragraph"/>As the S3 file upload support, you can override AWS credentials settings for sending mails. This is rare and unusual, but if you really need, do the same as in S3.<p class="paragraph"/><div class="code"><pre>credentials <span class="java&#45;quote">"<span class="java&#45;keyword">new</span>&#45;access&#45;key"</span>, <span class="java&#45;quote">"<span class="java&#45;keyword">new</span>&#45;secret&#45;key"</span></pre></div><p class="paragraph"/>Just remember, if this new AWS credentials belong to another AWS account, this account will have to be subscribed to SES service and have verified e-mails to send.<p class="paragraph"/><h4>Defining the sender</h4><p class="paragraph"/>As seen in the other topic, you can set this default address in the application Config, but if you want to explicitly set the address in each email you send, just override the <strong class="bold">from</strong> method:<p class="paragraph"/><div class="code"><pre>from <span class="java&#45;quote">"my&#45;other&#45;email@gmail.com"</span></pre></div><p class="paragraph"/><h4>Defining recipient e-mails</h4><p class="paragraph"/><h5>To</h5><p class="paragraph"/>To set the recipient e-mail, use the <strong class="bold">to</strong> method.<p class="paragraph"/><div class="code"><pre>to <span class="java&#45;quote">"user@myapp.com"</span></pre></div><p class="paragraph"/>You can send to multiple addresses doing this:<p class="paragraph"/><div class="code"><pre>to <span class="java&#45;quote">"user<code>myapp.com"</span>, <span class="java&#45;quote">"user2</code>myapp.com"</span>, <span class="java&#45;quote">"user3@myapp.com"</span></pre></div><p class="paragraph"/><h5>CC and BCC</h5><p class="paragraph"/>To set CC and BCC addresses, you can do the same as <strong class="bold">to</strong> addresses:<p class="paragraph"/><div class="code"><pre>cc <span class="java&#45;quote">"copied@myapp.com"</span></pre></div><p class="paragraph"/><div class="code"><pre>bcc <span class="java&#45;quote">"you&#45;dont&#45;know&#45;me&#64;myapp.com"</span></pre></div><p class="paragraph"/>And again, for multiple addresses:<p class="paragraph"/><div class="code"><pre>ccc <span class="java&#45;quote">"user1&#64;myapp.com"</span>, <span class="java&#45;quote">"user2&#64;myapp.com"</span>, <span class="java&#45;quote">"user3&#64;myapp.com"</span></pre></div><p class="paragraph"/><div class="code"><pre>bcc <span class="java&#45;quote">"user4&#64;myapp.com"</span>, <span class="java&#45;quote">"user5&#64;myapp.com"</span>, <span class="java&#45;quote">"user6&#64;myapp.com"</span></pre></div><p class="paragraph"/><h4>Setting the e-mail subject</h4><p class="paragraph"/>To set the subject, following other parameters convention:<p class="paragraph"/><div class="code"><pre>subject <span class="java&#45;quote">"Testing the AWS Plugin"</span></pre></div><p class="paragraph"/><h4>E-mail body</h4><p class="paragraph"/>And finally, the e-mail body can be set with:<p class="paragraph"/><div class="code"><pre>body <span class="java&#45;quote">"This is the text user will receive in the e&#45;mail body"</span></pre></div><h2><a name="3.2.3 Sending HTML emails">3.2.3 Sending HTML emails</a></h2>You can send html emails the same way you'd do with text e-mails, just instead of calling the <strong class="bold">body</strong> method, you have to pass the content to the <strong class="bold">html</strong> method:<p class="paragraph"/><div class="code"><pre>sesMail &#123;
   to <span class="java&#45;quote">"email@gmailcom"</span>
   subject <span class="java&#45;quote">"testing html emails"</span>
   html <span class="java&#45;quote">"&#60;html&#62;&#60;body&#62;&#60;h3&#62;HTML email&#60;/h3&#62;&#60;strong&#62;Strong text&#60;/strong&#62;&#60;/body&#62;&#60;/html&#62;"</span>
&#125;</pre></div><p class="paragraph"/><h3>Using GSP templates to generate html emails</h3><p class="paragraph"/>I bet you don't want to write all the HTML in your closure, so, you can design your e-mail in a grails template and use it to define the email content:<p class="paragraph"/><div class="code"><pre>sesMail &#123;
   to <span class="java&#45;quote">"email@gmailcom"</span>
   subject <span class="java&#45;quote">"testing html emails"</span>
   html g.render(template: <span class="java&#45;quote">"/email&#45;templates/template"</span>, model: &#91;name: <span class="java&#45;quote">"Lucas"</span>, now: <span class="java&#45;keyword">new</span> Date()&#93;)
&#125;</pre></div><p class="paragraph"/>This will render the <strong class="bold">/email-templates/_template.gsp</strong> passing the model map to the rendering engine. For example, let's imagine this file has the following content:<p class="paragraph"/><div class="code"><pre>&#60;html&#62;
   &#60;body&#62;
      &#60;h2&#62;Testing e&#45;mail templates&#60;/h2&#62;
      &#60;ul&#62;
         &#60;li&#62;Name: $&#123;name&#125;&#60;/li&#62;
         &#60;li&#62;Now: $&#123;now.format('dd/MM/yyyy HH:mm')&#125;&#60;/li&#62;
      &#60;/ul&#62;
   &#60;/body&#62;
&#60;/html&#62;</pre></div><p class="paragraph"/>This will send the html e-mail with the content below rendered:<p class="paragraph"/><div class="code"><pre>&#60;html&#62;
   &#60;body&#62;
      &#60;h2&#62;Testing e&#45;mail templates&#60;/h2&#62;
      &#60;ul&#62;
         &#60;li&#62;Name: Lucas&#60;/li&#62;
         &#60;li&#62;Now: 28/01/2010 18:02&#60;/li&#62;
      &#60;/ul&#62;
   &#60;/body&#62;
&#60;/html&#62;</pre></div><p class="paragraph"/><blockquote class="warning">
You can use both methods <strong class="bold">html</strong> and <strong class="bold">body</strong> to send e-mails with both content in it. This is usually the best approach, since user may not allowed his email client to render html emails. So, it is up to you.
</blockquote>
    </body>
</html>

<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>2.2 Uploading files</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    The plugin adds support for uploading files to Amazon S3, by adding a s3upload(...) method to <strong class="bold">File</strong> and <strong class="bold">InputStream</strong> classes, so you'll just need to call this method passing a closure with overwritten config options, but if you do not want to overwrite it, just leave this and the plugin will catch from the Config.groovy default options.<p class="paragraph"/><h3>Simple File upload from a File object</h3><p class="paragraph"/><div class="code"><pre>def s3file = <span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">"/tmp/test.txt"</span>).s3upload &#123;
    path <span class="java&#45;quote">"folder/to/my/file/"</span>
&#125;</pre></div><p class="paragraph"/>This way your test.txt file will be uploaded to<p class="paragraph"/><div class="code"><pre>&#60;<span class="java&#45;keyword">default</span>&#45;bucket&#62;.s3.amazonaws.com/folder/to/my/file/test.txt</pre></div><p class="paragraph"/>If you want to overwrite config during the file upload, check this guide next section.<p class="paragraph"/><h3>Uploading files directly from its InputStream</h3><p class="paragraph"/>This is useful when you don't have the file stored in your filesystem, and don't want to have.
When user uploads files to your application using a <strong class="bold">multipart/form-data</strong> form, you can upload it directly to s3. Imagine it have an upload form like this:<p class="paragraph"/><div class="code"><pre>&#60;g:uploadForm action=<span class="java&#45;quote">"uploadFromInputStream"</span>&#62;
    &#60;input type=<span class="java&#45;quote">"file"</span> name=<span class="java&#45;quote">"photo"</span>&#62;
    &#60;input type=<span class="java&#45;quote">"submit"</span> value=<span class="java&#45;quote">"upload"</span>&#62;
&#60;/g:uploadForm&#62;</pre></div><p class="paragraph"/>you could have your <strong class="bold">uploadFromInputStream</strong> action implemented this way:<p class="paragraph"/><div class="code"><pre>def file = request.getFile('photo')
def uploadedFile = file.inputStream.s3upload(file.originalFilename, file.size) &#123;
    bucket <span class="java&#45;quote">"file&#45;upload&#45;from&#45;inputstream"</span>
&#125;</pre></div><p class="paragraph"/><blockquote class="warning">
Uploading from InputStream requires 2 extra parameters, the filename and its size.
</blockquote><p class="paragraph"/>Note that when you use <strong class="bold">File</strong>.s3upload you just pass the closure that configures it. When using from one inputStream, you <strong class="bold">SHOULD</strong> have to specify the name that file will have and the file size. The above example show exactly how to do it with the correct info from the uploaded file.<p class="paragraph"/><h3>Storing uploaded information for later use</h3><p class="paragraph"/>If you are uploading some picture to S3, you'll probably need to store information on how to get that file again later.<p class="paragraph"/>The <strong class="bold">s3upload</strong> operation returns an instance of <strong class="bold">grails.plugin.aws.s3.S3File</strong>. As this plugin uses jets3t (<a href="http://jets3t.s3.amazonaws.com/index.html" target="blank">http://jets3t.s3.amazonaws.com/index.html</a>) to handle file upload, the S3File is just a wrapper for a <strong class="bold">delegated</strong> jets3t S3Object instance as you can see below:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> grails.plugin.aws.s3
<span class="java&#45;keyword">import</span> org.jets3t.service.model.S3Object<p class="paragraph"/>class S3File &#123;<p class="paragraph"/>    @Delegate S3Object source<p class="paragraph"/>    <span class="java&#45;keyword">public</span> S3File(S3Object _source) &#123;
        <span class="java&#45;keyword">this</span>.source = _source
    &#125;    
&#125;</pre></div><p class="paragraph"/>So, you can call any S3Object method on S3File instance. S3Object API is available here: <a href="http://jets3t.s3.amazonaws.com/api/org/jets3t/service/model/S3Object.html" target="blank">http://jets3t.s3.amazonaws.com/api/org/jets3t/service/model/S3Object.html</a>, for example, to retrieve the ETag hash for the S3File uploaded you would just call:<p class="paragraph"/><div class="code"><pre>def s3file = &#8230; //upload the file
def etag = s3file.getETag()</pre></div><p class="paragraph"/>The <strong class="bold">S3File</strong> object returned will give all information you'll need. Now, depends on what information you want to store. Follow S3Object docs (link above) and get whatever you want.<p class="paragraph"/>A common approach would be storing the bucket, path and file (key). With these parameters you can rebuild the URL to reach the file, or even delete the file. 
    </body>
</html>
